#pragma rtGlobals=1		// Use modern global access method.// since wavecalc's histogram function has gone bonkers...Function genehist ([refsintname,eventssintname,prefix])		String refsintname, eventssintname,prefix		if (Paramisdefault(refsintname))		Prompt refsintname, "name of reference events _sint wave",popup(WaveList("*sint",";",""))		Prompt eventssintname, "name of events _sint wave",popup(WaveList("*sint",";",""))		Prompt prefix, "prefix"		//Prompt start, "ms before reference (enter negative number)"		//Prompt stop, "ms after reference"		//Prompt binwidth, "binwidth"		DoPrompt "welcome to non-retarded histogram function", refsintname, eventssintname,prefix//, start, stop, binwidth	endif			Variable start = -5000		Variable stop = 5000	Variable binwidth = 1			WAVE refevents = $refsintname	WAVE events = $eventssintname		Variable numrefevents = refevents[9]	Variable numevents = events[9]	printf "%d reference events\r", numrefevents		Variable i,j, lowerbound, upperbound, properbin	Variable relativespiketime, relativespikems			String histname = prefix + "hist"	String windowname = prefix + "hist_w"	// make the histogram wave	Variable histlength = (stop - start)/binwidth	Make/O/n=(histlength) $histname = 0	WAVE histowave = $histname	SetScale/p x, start, binwidth, histowave			// how many datapoints per ms in events wave?	Variable eventsxscale = events[0]	// how many datapoints per ms in refevents wave?	Variable refeventsxscale = refevents[0]		Variable thisevent			// go through each reference event	for (i = 10; i < (10 + numrefevents); i += 1)			lowerbound = refevents[i] + start // start is a negative number		upperbound = refevents[i] + stop				//printf "checking ref %d\r", refevents[i]			// and check each of the events against it		for (j = 10; j < (10 + numevents); j += 1)					thisevent = events[j]						// if we find a match			if ((thisevent > lowerbound) && (thisevent < upperbound))				// now we've got an absolute number and need to map it				//	into the histowave				//printf "		matched %d\r", thisevent											// how many datapoints from lowerbound is it?				relativespiketime = (thisevent - lowerbound)				//printf "		relativepoint %d\r", relativespiketime				// so, how many ms from lowerbound is it?				relativespikems = relativespiketime					//printf "		relative ms %d\r", relativespikems						// floor or ceiling (datapoints / binwidth)				properbin = floor(relativespikems / binwidth)				//printf "		properbin %d\r", properbin				// increment the proper bin							histowave[properbin] += 1			endif		endfor			endfor				String refname = NameOfWave(refevents)	String swave = NameOfWave(events)	String str		WaveStats/q histowave		Variable totalcount=V_Avg * V_npnts		// Compute total counts in histo		Variable first50mstotal = histowave[20] + histowave[21] + histowave[22] + histowave[23] + histowave[24]  + histowave[25] + histowave[26] + histowave[27] + histowave[28] + histowave[29]	printf "total count in first 50 ms = %d\r", first50mstotal			// normalize	histowave /= numrefevents	SetScale d 0,0,"spikes/stim", histowave			dowindow/f $windowname			if (!V_flag)			Display histowave		str = "Modify rgb=(0,0,0),mode=5,"		str = str + "lsmooth=3,lhair=0.5,lsize=0.25,hbfill=4"		Execute str		SetAxis left 0, (1.25 * V_max)		//ind= strlen(perhtref)		Textbox /F=0/A=LT/X=1.5/Y=0  swave		Textbox /F=0/A=LT/X=1.5/Y=7.5  refname		Textbox /F=0/A=LT/X=80/Y=0  "Ns = " + num2str(totalcount)		Textbox /F=0/A=LT/X=80/Y=7.5  "Nr = " + num2str(refevents[9])		SetAxis left, 0, 10		modifygraph minor(bottom)= 1		vline(0)		dowindow/r/c $windowname	endifend// function to detect thresholds in the style of WaveCalc, but more transparently// enter everything in msFunction detectthresh(trace, epochstart, epochend, lower, deadtime)	Wave trace	Variable epochstart, epochend, lower, deadtime		Variable length = numpnts(trace)	Variable i		// pointnumber * scalefactor = ms	Variable scalefactor = DimDelta(trace,0)		// convert epochstart and epochend to point numbers		///  old way	/// (ms / scalefactor) = pointnumber	///	 epochstart /= scalefactor	///	 epochend /= scalefactor	///	 	///	 if (epochend == 0)	///	 	epochend = numpnts(trace)-1	///	endif		/// new way (09/2013)	epochstart = (epochstart > 0) ? x2pnt(trace, epochstart) : 0	epochend = (epochend > 0) ? x2pnt(trace, epochend) : numpnts(trace)-1		String newname = nameOfwave(trace) + "_sint"	Make/O/N=10 $newname	WAVE sint = $newname		Variable nextspot = 10		if (lower >= 0)		FindLevels/Q/EDGE=1/D=$newname/M=(deadtime)/R=[epochstart,epochend] trace, lower	elseif (lower < 0)		 FindLevels/Q/EDGE=2/D=$newname/M=(deadtime)/R=[epochstart,epochend] trace, lower	endif		InsertPoints 0, 10, sint	sint[0] = scalefactor	sint[1] = epochstart	sint[2] = epochend	sint[3] = lower	sint[8] = deadtime	sint[9] = V_LevelsFound	end// based on detectthresh: function to detect thresholds in the style of WaveCalc, but more transparently// enter everything in ms// needs to exclude level crossings not followed by a reverse crossing within a certain amount of timeFunction detectMUAspikes(trace, epochstart, epochend, lower, mininterpeaktime, maxpeakwidth)	Wave trace	Variable epochstart, epochend, lower, mininterpeaktime,maxpeakwidth		Variable length = numpnts(trace)	Variable i		// pointnumber * scalefactor = ms	Variable scalefactor = DimDelta(trace,0)			// (ms / scalefactor) = pointnumber	epochstart /= scalefactor	epochend /= scalefactor		if (epochend == 0)		epochend = numpnts(trace)-1	endif 		String newname = nameOfwave(trace) + "_sint"	Make/O/N=10 $newname	WAVE sint = $newname		Variable nextspot = 10		if (lower >= 0)		FindLevels/Q/EDGE=1/D=$newname/M=(mininterpeaktime)/R=[epochstart,epochend] trace, lower	elseif (lower < 0)		FindLevels/Q/EDGE=2/D=$newname/M=(mininterpeaktime)/R=[epochstart,epochend] trace, lower	endif		InsertPoints 0, 10, sint	sint[0] = scalefactor	sint[1] = epochstart	sint[2] = epochend	sint[3] = lower	sint[8] = mininterpeaktime	sint[9] = V_LevelsFound		duplicate/o sint sint_test	for (i=10; i < numpnts(sint); i += 1)			if (lower >= 0)			FindLevel/Q/EDGE=2/R=(sint[i],sint[i]+maxpeakwidth) trace, lower		elseif (lower < 0)			FindLevel/Q/EDGE=1/R=(sint[i],sint[i]+maxpeakwidth) trace, lower		endif		sint_test[i]= V_flag	endforend// hist function that works with detectthreshFunction genehist2 ()		String refname, spikesname	Variable start, stop, binwidth, refthresh, refdeadtime, spikesthresh, spikesdeadtime, epochstart, epochend		Prompt refname, "name of reference events wave",popup(WaveList("*",";",""))	Prompt refthresh, "reference threshold"	Prompt refdeadtime, "reference deadtime"	Prompt spikesname, "name of spikes wave",popup(WaveList("*",";",""))	Prompt spikesthresh, "spikes threshold"	Prompt spikesdeadtime, "spikes deadtime"	Prompt epochstart, "start looking (ms)"	prompt epochend, "stop looking (ms)"	Prompt start, "for histogram, ms before reference (enter negative number)"	Prompt stop, "for histogram, ms after reference"	Prompt binwidth, "for histogram, binwidth"	DoPrompt "welcome to non-retarded histogram function", refname, refthresh, refdeadtime, spikesname, spikesthresh, spikesdeadtime, epochstart, epochend		if (V_flag == 1)		abort	endif		Prompt start, "for histogram, ms before reference (enter negative number)"	Prompt stop, "for histogram, ms after reference"	Prompt binwidth, "for histogram, binwidth"	DoPrompt "histogram info", start, stop, binwidth		//start = -100	//stop = 100	//binwidth = 5		WAVE ref = $refname	WAVE spikes = $spikesname	detectthresh(ref, epochstart, epochend, refthresh, refdeadtime)	detectthresh(spikes, epochstart, epochend, spikesthresh, spikesdeadtime)		String refsintname = refname + "_sint"	String eventssintname = spikesname + "_sint"		WAVE refevents = $refsintname	WAVE events = $eventssintname		Variable numrefevents = refevents[9]	Variable numevents = events[9]	printf "%d reference events\r", numrefevents		Variable i,j, lowerbound, upperbound, properbin	Variable relativespiketime, relativespikems		// make the histogram wave	Variable histlength = (stop - start)/binwidth	Make/O/n=(histlength) histowave = 0	SetScale/p x, start, binwidth, histowave			// how many datapoints per ms in events wave?	Variable eventsxscale = events[0]	// how many datapoints per ms in refevents wave?	Variable refeventsxscale = refevents[0]		Variable thisevent		// go through each reference event	for (i = 10; i < (10 + numrefevents); i += 1)			lowerbound = refevents[i] + start // start is a negative number		upperbound = refevents[i] + stop				//printf "checking ref %d\r", refevents[i]			// and check each of the events against it		for (j = 10; j < (10 + numevents); j += 1)					thisevent = events[j]						// if we find a match			if ((thisevent > lowerbound) && (thisevent < upperbound))				// now we've got an absolute number and need to map it				//	into the histowave				//printf "		matched %d\r", thisevent											// how many datapoints from lowerbound is it?				relativespiketime = (thisevent - lowerbound)				//printf "		relativepoint %d\r", relativespiketime				// so, how many ms from lowerbound is it?				relativespikems = relativespiketime								//printf "		relative ms %d\r", relativespikems						// floor or ceiling (datapoints / binwidth)				properbin = floor(relativespikems / binwidth)				//printf "		properbin %d\r", properbin				// increment the proper bin							histowave[properbin] += 1			endif		endfor			endfor		refname = NameOfWave(refevents)	String swave = NameOfWave(events)	String str		WaveStats/q histowave		Variable totalcount=V_Avg * V_npnts		// Compute total counts in histo	Display histowave	str = "Modify rgb=(0,0,0),mode=5,zero(bottom)=1,"	str = str + "lsmooth=3,lhair=0.5,lsize=0.25,hbfill=4"	Execute str	SetAxis left 0, (1.25 * V_max)	Label left "counts" 	//ind= strlen(perhtref)	Textbox /F=0/A=LT/X=1.5/Y=0  swave	Textbox /F=0/A=LT/X=1.5/Y=7.5  refname	Textbox /F=0/A=LT/X=80/Y=0  "Ns = " + num2str(totalcount)	Textbox /F=0/A=LT/X=80/Y=7.5  "Nr = " + num2str(refevents[9])	SetAxis left 0,15end// hist function that works with detectthreshFunction genehist3 ()		String refname, spikesname, skipYN	Variable start, stop, binwidth, refthresh, refdeadtime, spikesthresh, spikesdeadtime, epochstart, epochend		Prompt refname, "name of reference timestamps (µs) wave",popup(WaveList("*",";",""))	Prompt skipYN, "skip every other timestamp?\r (Y if ref has TTL up and down)",popup("Y;N")	Prompt spikesname, "name of spikes wave",popup(WaveList("*",";",""))	Prompt spikesthresh, "spikes threshold"	Prompt spikesdeadtime, "spikes deadtime"	Prompt epochstart, "start (ms); 0=all"	prompt epochend, "stop (ms); 0=all"	Prompt start, "for histogram, ms before reference (enter negative number)"	Prompt stop, "for histogram, ms after reference"	Prompt binwidth, "for histogram, binwidth"	DoPrompt "welcome to histogram function", refname, skipYN, spikesname, spikesthresh, spikesdeadtime, epochstart, epochend		if (V_flag == 1)		abort	endif		Prompt start, "for histogram, ms before reference (enter negative number)"	Prompt stop, "for histogram, ms after reference"	Prompt binwidth, "for histogram, binwidth"	DoPrompt "histogram info", start, stop, binwidth		//start = -100	//stop = 100	//binwidth = 5		WAVE ref = $refname	WAVE spikes = $spikesname	// need to turn refname into a sint wave	// have I already converted this into ms?	string timestamps_ms_name = nameofwave(ref)+"_ms"	if (!waveexists($timestamps_ms_name))		duplicate ref $timestamps_ms_name/WAVE=timestampswave_ms		timestampswave_ms /= 1000	else		WAVE timestampswave_ms = $timestamps_ms_name	endif		String refsintname = refname + "_ms_sint"	duplicate/O timestampswave_ms $(refsintname)/WAVE=refevents		InsertPoints 0, 10, refevents		//	these things don't really have meaning for reference event waves from cheetah	//	refsint[0] = scalefactor	//	refsint[1] = epochstart	//	refsint[2] = epochend	//	refsint[3] = lower	//	refsint[8] = mininterpeaktime	//	refsint[9] = V_LevelsFound		detectthresh(spikes, epochstart, epochend, spikesthresh, spikesdeadtime)		String eventssintname = spikesname + "_sint"		WAVE events = $eventssintname		// are we skipping?	variable skip = (stringmatch(skipYN,"Y"))	variable increment = (skip) ? 2 : 1		Variable numevents = events[9]		Variable i,j, lowerbound, upperbound, properbin	Variable relativespiketime, relativespikems		// make the histogram wave	Variable histlength = (stop - start)/binwidth	Make/O/n=(histlength) histowave = 0	SetScale/p x, start, binwidth, histowave	Variable thisevent		// if we aren't doing the whole thing, need to adjust event indices to match the input epoch numbers	variable firsteventindex, lasteventindex	if (epochstart > 0)		// find first refevent after epochstart		findlevel/R=[0,]/P refevents, epochstart		firsteventindex = ceil(V_levelX)	else		firsteventindex = 10	endif			if (epochend > 0)			// find last refevent before epochend		findlevel/R=[firsteventindex,]/P refevents, epochend		lasteventindex = floor(V_levelX)	else		lasteventindex = numpnts(refevents)-increment	endif		Variable numrefevents = ((lasteventindex - firsteventindex)/increment)+1	printf "%d reference events\r", numrefevents	// go through each reference event	for (i = firsteventindex; i < lasteventindex; i += increment)			lowerbound = refevents[i] + start // start is a negative number		upperbound = refevents[i] + stop				//printf "checking ref %d\r", refevents[i]			// and check each of the events against it		for (j = 10; j < (10 + numevents); j += 1)					thisevent = events[j]						// if we find a match			if ((thisevent > lowerbound) && (thisevent < upperbound))				// now we've got an absolute number and need to map it				//	into the histowave				//printf "		matched %d\r", thisevent											// how many datapoints from lowerbound is it?				relativespiketime = (thisevent - lowerbound)				//printf "		relativepoint %d\r", relativespiketime				// so, how many ms from lowerbound is it?				relativespikems = relativespiketime								//printf "		relative ms %d\r", relativespikems						// floor or ceiling (datapoints / binwidth)				properbin = floor(relativespikems / binwidth)				//printf "		properbin %d\r", properbin				// increment the proper bin							histowave[properbin] += 1			endif		endfor			endfor		refname = NameOfWave(refevents)	String swave = NameOfWave(events)	String str		WaveStats/q histowave		Variable totalcount=V_Avg * V_npnts		// Compute total counts in histo	Display histowave	str = "Modify rgb=(0,0,0),mode=5,zero(bottom)=1,"	str = str + "lsmooth=3,lhair=0.5,lsize=0.25,hbfill=4"	Execute str	SetAxis left 0, (1.25 * V_max)	Label left "counts" 	//ind= strlen(perhtref)	Textbox /F=0/A=LT/X=1.5/Y=0  swave	Textbox /F=0/A=LT/X=1.5/Y=7.5  refname	Textbox /F=0/A=LT/X=80/Y=0  "Ns = " + num2str(totalcount)	Textbox /F=0/A=LT/X=80/Y=7.5  "Nr = " + num2str(numrefevents)	SetAxis left 0,15end//  hist function that works with detectthresh//    refname, "name of reference timestamps (µs) wave",popup(WaveList("*",";",""))//	"skip every other timestamp?\r (Y if ref has TTL up and down)",popup("Y;N")//	Prompt spikesname, "name of spikes wave",popup(WaveList("*",";",""))//	Prompt spikesthresh, "spikes threshold"//	Prompt spikesdeadtime, "spikes deadtime"//	Prompt epochstart, "start (ms); 0=all"//	prompt epochend, "stop (ms); 0=all"//	Prompt start, "for histogram, ms before reference (enter negative number)"//	Prompt stop, "for histogram, ms after reference"//	Prompt binwidth, "for histogram, binwidth"//	DoPrompt "welcome to histogram function", refname, skipYN, spikesname, spikesthresh, spikesdeadtime, epochstart, epochend//	Prompt start, "for histogram, ms before reference (enter negative number)"//	Prompt stop, "for histogram, ms after reference"//	Prompt binwidth, "for histogram, binwidth"//	DoPrompt "histogram info", start, stop, binwidth//	Function genehist3_nodialog (refname, spikesname, skipYN,start, stop, binwidth, refthresh, refdeadtime, spikesthresh, spikesdeadtime, epochstart, epochend)	String refname, spikesname, skipYN	Variable start, stop, binwidth, refthresh, refdeadtime, spikesthresh, spikesdeadtime, epochstart, epochend		WAVE ref = $refname	WAVE spikes = $spikesname	// need to turn refname into a sint wave	// have I already converted this into ms?	string timestamps_ms_name = nameofwave(ref)+"_ms"	if (!waveexists($timestamps_ms_name))		duplicate ref $timestamps_ms_name/WAVE=timestampswave_ms		timestampswave_ms /= 1000	else		WAVE timestampswave_ms = $timestamps_ms_name	endif		String refsintname = refname + "_ms_sint"	duplicate/O timestampswave_ms $(refsintname)/WAVE=refevents		InsertPoints 0, 10, refevents		//	these things don't really have meaning for reference event waves from cheetah	//	refsint[0] = scalefactor	//	refsint[1] = epochstart	//	refsint[2] = epochend	//	refsint[3] = lower	//	refsint[8] = mininterpeaktime	//	refsint[9] = V_LevelsFound		detectthresh(spikes, epochstart, epochend, spikesthresh, spikesdeadtime)		String eventssintname = spikesname + "_sint"		WAVE events = $eventssintname		// are we skipping?	variable skip = (stringmatch(skipYN,"Y"))	variable increment = (skip) ? 2 : 1		Variable numevents = events[9]		Variable i,j, lowerbound, upperbound, properbin	Variable relativespiketime, relativespikems		// make the histogram wave	Variable histlength = (stop - start)/binwidth	Make/O/n=(histlength) histowave = 0	SetScale/p x, start, binwidth, histowave	Variable thisevent		// if we aren't doing the whole thing, need to adjust event indices to match the input epoch numbers	variable firsteventindex, lasteventindex	if (epochstart > 0)		// find first refevent after epochstart		findlevel/R=[0,]/P refevents, epochstart		firsteventindex = ceil(V_levelX)	else		firsteventindex = 10	endif			if (epochend > 0)			// find last refevent before epochend		findlevel/R=[firsteventindex,]/P refevents, epochend		lasteventindex = floor(V_levelX)	else		lasteventindex = numpnts(refevents)-increment	endif		Variable numrefevents = ((lasteventindex - firsteventindex)/increment)+1	printf "%d reference events\r", numrefevents	// go through each reference event	for (i = firsteventindex; i < lasteventindex; i += increment)			lowerbound = refevents[i] + start // start is a negative number		upperbound = refevents[i] + stop				//printf "checking ref %d\r", refevents[i]			// and check each of the events against it		for (j = 10; j < (10 + numevents); j += 1)					thisevent = events[j]						// if we find a match			if ((thisevent > lowerbound) && (thisevent < upperbound))				// now we've got an absolute number and need to map it				//	into the histowave				//printf "		matched %d\r", thisevent											// how many datapoints from lowerbound is it?				relativespiketime = (thisevent - lowerbound)				//printf "		relativepoint %d\r", relativespiketime				// so, how many ms from lowerbound is it?				relativespikems = relativespiketime								//printf "		relative ms %d\r", relativespikems						// floor or ceiling (datapoints / binwidth)				properbin = floor(relativespikems / binwidth)				//printf "		properbin %d\r", properbin				// increment the proper bin							histowave[properbin] += 1			endif		endfor			endfor		refname = NameOfWave(refevents)	String swave = NameOfWave(events)	String str		WaveStats/q histowave		Variable totalcount=V_Avg * V_npnts		// Compute total counts in histo	Display histowave	str = "Modify rgb=(0,0,0),mode=5,zero(bottom)=1,"	str = str + "lsmooth=3,lhair=0.5,lsize=0.25,hbfill=4"	Execute str	SetAxis left 0, (1.25 * V_max)	Label left "counts" 	//ind= strlen(perhtref)	Textbox /F=0/A=LT/X=1.5/Y=0  swave	Textbox /F=0/A=LT/X=1.5/Y=7.5  refname	Textbox /F=0/A=LT/X=80/Y=0  "Ns = " + num2str(totalcount)	Textbox /F=0/A=LT/X=80/Y=7.5  "Nr = " + num2str(numrefevents)	SetAxis left 0,15end// scale is number of ms / pointFunction mergewaveswell (thewave, mergearound, lower,deadtime, pretime, posttime)	Wave thewave,mergearound	Variable lower	Variable deadtime,pretime,posttime	Variable length = numpnts(mergearound)	Variable refscale = dimdelta(mergearound,0)	Variable scale = dimdelta(thewave,0)				Variable lengthinms = length*scale	Variable pretimepts = pretime/scale	Variable posttimepts = posttime/scale		String namestring = (nameofwave(thewave) + "on" +nameofwave(mergearound) + "t")		detectthresh(mergearound, 0, lengthinms, lower, deadtime)	// results in creation of thewave_sint	WAVE refevents = $(nameofwave(mergearound) + "_sint")	Variable numevents = refevents[9],i		Variable minilengthinms = pretime + posttime	Variable minilength = minilengthinms/scale		//print minilengthinms,minilength		for (i=0; i < numevents; i += 1)		//print pretimepts		make/O/n=(minilength) $(namestring + num2str(i))		WAVE miniwave = $(namestring + num2str(i))		//print refevents[10+i]*scale - pretimepts		miniwave = thewave[refevents[10+i]/scale - pretimepts + p]		setscale/p x,-1*pretime,scale,miniwave			endfor		fwaveaverage(WaveList(namestring+"*",";",""),"",0,0,(nameofwave(thewave) + "on" +nameofwave(mergearound)),"")	Wave theaverage = $(nameofwave(thewave) + "on" +nameofwave(mergearound))		setscale/p x,-1*pretime,scale,theaverage	display theaverage		end// scale is number of ms / point// mergewavesfromsint doesn't need to make the sint wave, but receives it as an argument// single trial waves will be named starting with trialoffset numberFunction mergewavesfromsint (thewave, sint, pretime, posttime, trialoffset)	Wave thewave,sint	Variable pretime,posttime	Variable trialoffset				Variable length = numpnts(thewave)	Variable refscale = dimdelta(thewave,0)	Variable scale = dimdelta(thewave,0)				Variable lengthinms = length*scale	Variable pretimepts = pretime/scale	Variable posttimepts = posttime/scale		String namestring = (nameofwave(thewave) + "on" +nameofwave(sint) + "t")	String sintname = nameofwave(sint)	string stimwavename = sintname[0,strlen(sintname) - 6]		WAVE refevents = sint	Variable numevents = refevents[9],i		Variable minilengthinms = pretime + posttime	Variable minilength = minilengthinms/scale		//print minilengthinms,minilength		for (i=0; i < numevents; i += 1)		//print pretimepts		make/O/n=(minilength) $(namestring + num2str(trialoffset+i))		WAVE miniwave = $(namestring + num2str(trialoffset+i))		//print refevents[10+i]*scale - pretimepts		miniwave = thewave[refevents[10+i]/scale - pretimepts + p]		setscale/p x,-1*pretime,scale,miniwave			endfor		fwaveaverage(WaveList(namestring+"*",";",""),"",0,0,(nameofwave(thewave) + "on" + stimwavename),"")	Wave theaverage = $(nameofwave(thewave) + "on" + stimwavename)		setscale/p x,-1*pretime,scale,theaverage	display theaverage		endfunction displayEveryNth (offset)	variable offset	string prefix = "ch6onpiezot"	string name	variable i		display		for (i=offset; i < 240; i += 12)				name = prefix + num2str(i)		appendtograph $name			endfor		ModifyGraph lsize=0.2,rgb=(0,0,0)	offsetgene(xoffset=0,yoffset=4)	SetAxis bottom -5000,4999.9 	SetAxis left -1.96871,80	end	// separate// takes a _sint wave containing a series of values and makes a wave for each value containing the indices of that valueFunction separate (inputwave)	wave inputwave		variable length = numpnts(inputwave),i	String listname		for (i=10; i < numpnts(inputwave); i += 1)			listname = "isi_"+num2str(inputwave[i])		WAVE list = $listname				if (Exists(listname))			redimension/n=(numpnts(list)+1) list			list[numpnts(list)-1] = i-10		else			make/o/i/n=1 $listname = i-10		endif	endforend	// input is _sint waves from detectthreshFunction groupstims (stim_sint, prestim_sint)	WAVE stim_sint,prestim_sint		duplicate/o stim_sint intervals		intervals = stim_sint - prestim_sint	intervals /= 5;intervals = floor(intervals);intervals *= 5	separate(intervals)end// displaylistFunction displaylist (prefix, triallist)	String prefix	wave triallist		variable howmany = numpnts(triallist)	variable i		String name = prefix + num2str(triallist[0])	display $name		for (i=1; i < howmany; i += 1)			name = prefix + num2str(triallist[i])		appendtograph $name		endfor		offsetgene (xoffset=0,yoffset=3)	modifygraph rgb=(0,0,0),lsize=0.2,minor(bottom)=1	vline(0);vline(100)	end	Function editVSDforLFP (triallist)	WAVE triallist		variable num = numpnts(triallist),i,testvalue	for (i=0; i < num; i += 1)			testvalue = triallist[i]				if (testvalue <= 567)			triallist[i] -= 393		elseif (testvalue == 568)			triallist[i] = Nan		elseif ((testvalue >= 569) && (testvalue <= 693))			triallist[i] -= 394		elseif (testvalue >= 695)			triallist[i] -= 395			endif		endforend// binsize in ms// mode = 0; output in spike count// mode = 1; output in Hz// create bin wave according to specifications// go through bins and for each bin:	// establish upper and lower bounds for the bin	// cycle through spike times starting from the value that broke you out of the last loop/bin	// increment a count for each time you find a value between upper and lower	//	stop cycling when you hit a value bigger than upper or when you get to the end of the sintwaveFunction ratemeter (sintwave, binsize, mode)	WAVE sintwave	variable binsize, mode		variable pointsintrace = sintwave[2]	variable deltaoftrace = sintwave[0]		variable msintrace = pointsintrace*deltaoftrace		variable outputlength = round(msintrace/binsize)	string sintname = nameofwave(sintwave)		string name = sintname[0,strlen(sintname) - 6] + "rate"	make/O/n=(outputlength) $name	WAVE ratemeter = $name		// shift it by half a bin size for graphical purposes	setscale/p x,binsize/2,binsize,"ms",ratemeter		variable i,count, lowerbound,upperbound, j=10		for (i=0; i < (outputlength-1); i += 1)			count = 0				lowerbound  = i*binsize		upperbound = (i+1) * binsize				do			if ((sintwave[j] >= lowerbound) && (sintwave[j] < upperbound))								count += 1							endif						if (sintwave[j] >= upperbound)				break			endif						j += 1		while (j < numpnts(sintwave))		ratemeter[i] = count		//if (mod(i,1000) == 0)			//print i		//endif	endfor	if (mode)				ratemeter *= (1000/binsize)		setscale/p y,0,1, "Hz", ratemeter	else				setscale/p y, 0,1,"spikes", ratemeter		endifendFunction isidist (sintwave)	wave sintwave		variable length = numpnts(sintwave)	variable nevents = length - 10, i		make/O/n=(nevents-1) ISIwave		for (i=0; i < (nevents - 1); i += 1)			ISIwave[i] = (sintwave[11+i] - sintwave[10+i])		endfor		make/O/n=5000 ISIhist	histogram/b={0,1,5000} ISIwave, ISIhist	endFunction batchfindcrossing (matchstring, level)	string matchstring	variable level		variable i	string waves = wavelist("*"+matchstring+"*",";","")	variable numwaves = itemsinlist(waves)	make/n=(numwaves)/O levelcrosstimes		for (i=0; i < numwaves; i += 1)				string nextwavename = stringfromlist(i,waves)		WAVE nextwave = $nextwavename				findlevel/EDGE=2/Q nextwave, level		levelcrosstimes[i] = V_LevelX			endfor		end// function now returns peak instantaneousrateFunction instantaneousrate (sintwave)	WAVE sintwave		String prefix = uptowhatever(nameofwave(sintwave), "_sint")		duplicate/O sintwave temprate		differentiate/METH=2 temprate	temprate = 1/temprate		temprate *= 1000		make/O/n=(numpnts(sintwave),2) $(prefix+"_irate")	WAVE instantaneousrate = $(prefix+"_irate")		instantaneousrate[][0] = temprate[p]	instantaneousrate[][1] = sintwave[p]		deletepoints/m=0 0, 11, instantaneousrate		display instantaneousrate[][0] vs instantaneousrate[][1]		wavestats/Q/R=[10,] temprate	killwaves temprate	return V_max	end